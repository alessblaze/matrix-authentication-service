{#
Copyright 2024, 2025 New Vector Ltd.
Copyright 2021-2024 The Matrix.org Foundation C.I.C.

SPDX-License-Identifier: AGPL-3.0-only OR LicenseRef-Element-Commercial
Please see LICENSE files in the repository root for full details.
-#}

{% extends "base.html" %}

{% block title %}Login - AMS{% endblock title %}

{% from "components/idp_brand.html" import logo %}

{% block content %}
  <style>
    body { background: linear-gradient(135deg, rgb(76 29 149), rgb(88 28 135), rgb(67 56 202)) !important; min-height: 100vh; }
    .layout-container { background: transparent !important; }
    form { background: rgba(255, 255, 255, 0.1) !important; backdrop-filter: blur(10px) !important; border-radius: 1rem !important; padding: 2rem !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; }
    .cpd-text-control { background: rgba(255, 255, 255, 0.1) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; color: white !important; }
    .cpd-text-control::placeholder { color: rgba(196, 181, 253, 0.6) !important; }
    .cpd-text-control:focus { border-color: rgb(139, 92, 246) !important; box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3) !important; }
    .cpd-button[data-kind="secondary"] { background: rgba(255, 255, 255, 0.1) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; color: white !important; }
    .cpd-button[data-kind="secondary"]:hover { background: rgba(255, 255, 255, 0.2) !important; }
    .cpd-text-secondary { color: rgba(196, 181, 253, 0.8) !important; }
    .title, .text { color: white !important; }
    .cpd-button[data-kind="primary"], .cpd-button:not([data-kind]) { background: rgb(139, 92, 246) !important; border: 1px solid rgb(139, 92, 246) !important; color: white !important; }
    .cpd-button[data-kind="primary"]:hover, .cpd-button:not([data-kind]):hover { background: rgb(124, 58, 237) !important; border: 1px solid rgb(124, 58, 237) !important; }
    .text-critical { background: rgba(239, 68, 68, 0.2) !important; border: 1px solid rgba(239, 68, 68, 0.4) !important; color: rgb(254, 202, 202) !important; padding: 0.75rem !important; border-radius: 0.5rem !important; margin-bottom: 1rem !important; text-align: center !important; }
    .icon { background: rgba(255, 255, 255, 0.1) !important; border: 1px solid rgba(255, 255, 255, 0.2) !important; border-radius: 0.75rem !important; padding: 1rem !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; }
    .icon svg { color: white !important; width: 2rem !important; height: 2rem !important; }
  </style>
  <form method="POST" class="flex flex-col gap-10">
    <header class="page-heading">
      <div class="icon">
        {{ icon.user_profile_solid() }}
      </div>

      {% if next and next.kind == "link_upstream" %}
        <div class="header">
          <h1 class="title">{{ _("mas.login.link.headline") }}</h1>
          {% set name = provider.human_name or (provider.issuer | simplify_url(keep_path=True)) or provider.id %}
          <p class="text">{{ _("mas.login.link.description", provider=name) }}</p>
        </div>
      {% else %}
        <div class="header">
          <h1 class="title">{{ _("mas.login.headline") }}</h1>
        </div>
      {% endif %}
    </header>

    <div class="cpd-form-root">
      {% if form.errors is not empty %}
        {% for error in form.errors %}
          <div class="text-critical font-medium">
            {{ errors.form_error_message(error=error) }}
          </div>
        {% endfor %}
      {% endif %}

      <input type="hidden" name="csrf" value="{{ csrf_token }}" />

      {% if features.login_with_email_allowed %}
        {% call(f) field.field(label=_("mas.login.username_or_email"), name="username", form_state=form) %}
          <input {{ field.attributes(f) }} class="cpd-text-control bg-white/10 border-white/20 text-white placeholder-violet-300/60 focus:ring-violet-400" type="text" autocomplete="username" autocorrect="off" autocapitalize="off" {% if features.email_otp_required and form.fields.username and form.fields.username.value %}readonly style="opacity: 0.7;"{% else %}required{% endif %} />
        {% endcall %}
      {% else %}
        {% call(f) field.field(label=_("common.username"), name="username", form_state=form) %}
          <input {{ field.attributes(f) }} class="cpd-text-control bg-white/10 border-white/20 text-white placeholder-violet-300/60 focus:ring-violet-400" type="text" autocomplete="username" autocorrect="off" autocapitalize="off" {% if features.email_otp_required and form.fields.username and form.fields.username.value %}readonly style="opacity: 0.7;"{% else %}required{% endif %} />
        {% endcall %}
      {% endif %}

      {% if features.password_login %}
        {% call(f) field.field(label=_("common.password"), name="password", form_state=form) %}
          <input {{ field.attributes(f) }} class="cpd-text-control bg-white/10 border-white/20 text-white placeholder-violet-300/60 focus:ring-violet-400" type="password" autocomplete="password" required />
        {% endcall %}

        {% if features.email_otp_required and form.fields.username and form.fields.username.value %}
          <p class="cpd-text-secondary text-sm mb-4">Please write your password again and enter the verification code sent to your email</p>
          {% call(f) field.field(label=_("mas.verify_email.6_digit_code"), name="otp_code", form_state=form) %}
            <input {{ field.attributes(f) }} class="cpd-text-control bg-white/10 border-white/20 text-white placeholder-violet-300/60 focus:ring-violet-400" type="text" placeholder="123456" maxlength="6" inputmode="numeric" pattern="\d{6}" autocomplete="one-time-code" />
          {% endcall %}
          <p class="cpd-text-secondary text-sm">Check your email for verification code</p>
        {% endif %}

        {% if features.account_recovery %}
          {{ button.link_text(text=_("mas.login.forgot_password"), href="/recover", class="self-center") }}
        {% endif %}
      {% endif %}
      
      {{ captcha.form(class="mb-4 self-center") }}
      
      {% for error in form.errors %}
        {# Special case for the captcha error #}
        {% if error.kind == "captcha" %}
          <div class="text-critical font-medium text-center -mt-4 mb-4">
            {{ errors.form_error_message(error=error) }}
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <div class="cpd-form-root">
      {% if features.password_login %}
        {{ button.button(text=_("action.continue")) }}
      {% endif %}

      {% if features.password_login and providers %}
        {{ field.separator() }}
      {% endif %}

      {% if providers %}
        {% set params = next["params"] | default({}) | to_params(prefix="?") %}
        {% for provider in providers %}
          {% set name = provider.human_name or (provider.issuer | simplify_url(keep_path=True)) or provider.id %}
          <a class="cpd-button {%- if provider.brand_name %} has-icon {%- endif %}" data-kind="secondary" data-size="lg" href="{{ ('/upstream/authorize/' ~ provider.id ~ params) | prefix_url }}">
            {{ logo(provider.brand_name) }}
            {{ _("mas.login.continue_with_provider", provider=name) }}
          </a>
        {% endfor %}
      {% endif %}
    </div>

    {% if (not next or next.kind != "link_upstream") and features.password_registration %}
      <div class="text-center cpd-text-body-md-regular">
        <p class="cpd-text-secondary mb-4">
          {{ _("mas.login.call_to_register") }}
        </p>

        {% set params = next["params"] | default({}) | to_params(prefix="?") %}
        <a href="/register{{ params }}" class="cpd-button" data-kind="secondary" data-size="lg">
          {{ _("action.create_account") }}
        </a>
      </div>
    {% endif %}

    {% if not providers and not features.password_login %}
      <div class="text-center">
        {{ _("mas.login.no_login_methods") }}
      </div>
    {% endif %}
  </form>
{% endblock content %}
